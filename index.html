<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREYMATTER - Influencer ROI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Quicksand';
            src: url('./greymatter_materials/Quicksand-VariableFont_wght.ttf') format('truetype');
            font-weight: 300 700;
            font-display: swap;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #636e72;
            min-height: 100vh;
            color: #2d3436;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        /* --- top banner tweaks --- */
:root{
    --bg-slate: #636e72;   /* main page grey */
    --bg-logo : #e6e6e6;   /* light square behind logo */
}

.header{
    background: var(--bg-logo);
    display: flex;
    flex-direction: column;    /* stack logo / headline / subtitle */
    align-items: center;
    gap: 15px;
    padding: 60px 40px;
    border-radius: 25px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    border: 1px solid #4a5568;
    margin-bottom: 40px;
}

.logo{
    height: 220px;             /* bigger logo */
    width : auto;
    
}

.header h1{
    color: #2d3436;    /* same grey as body */
    font-size: 3.2rem;
    font-weight: 700;
    margin: 0;
    text-shadow: none;         /* cleaner on light bg */
}


        .header p {
            font-size: 1.1rem;
            color: #2d3436;
            font-weight: 400;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e8ebf0;
        }

        .tab-button {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 20px;
            color: #636e72;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: #f8f9fc;
            color: #2d3436;
        }

        .tab-button.active {
            background: #2d3436;
            color: white;
            box-shadow: 0 2px 8px rgba(45, 52, 54, 0.15);
        }

        .tab-content {
            display: none !important;
            background: white;
            border-radius: 20px;
            padding: 10px 30px 30px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        /* Dashboard tab needs more padding for better spacing */
        .tab-content#dashboard {
            padding: 30px;
        }

        .tab-content.active {
            display: block !important;
        }

        /* Hide only dashboard-specific elements when not active */
        .tab-content:not(.active)#dashboard .dashboard-grid,
        .tab-content:not(.active)#dashboard .stats-grid,
        .tab-content:not(.active)#dashboard canvas,
        .tab-content:not(.active)#dashboard #heatmapChart,
        .tab-content:not(.active)#dashboard #topInfluencersChart {
            display: none !important;
            visibility: hidden !important;
        }

        /* Only hide dashboard chart cards, not all chart cards */
        .tab-content:not(.active)#dashboard .chart-card {
            display: none !important;
            visibility: hidden !important;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            padding-left: 30px;
            padding-right: 30px;
            box-sizing: border-box;
        }

        .chart-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e8ebf7;
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #4a5568;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .influencer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .influencer-table th,
        .influencer-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .influencer-table th {
            background: #2d3436;
            color: white;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s ease;
        }

        .influencer-table th:hover {
            background: #636e72;
        }

        .influencer-table tr:hover {
            background: #f7fafc;
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8rem;
        }

        .account-name {
            font-weight: 600;
            color: #2d3436;
        }

        .roi-score {
            font-weight: 700;
            color: #48bb78;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2d3436;
        }

        .btn {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 52, 54, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            margin-left : 25px;
            margin-right: 25px;
            box-sizing : border-box;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card.grey {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #f0fff4;
            color: #2f855a;
            border: 1px solid #c6f6d5;
        }

        .alert.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        /* ───────────────────────────────
   Responsive tweaks (≤ 768 px)
   ─────────────────────────────── */
@media (max-width: 768px){

.dashboard-grid{ grid-template-columns: 1fr; }
.form-grid     { grid-template-columns: 1fr; }

.header h1{ font-size: 2rem; }

.tabs{ flex-direction: column; }
}   /* ← end @media */


/* ─────────────────────────────────────────────
Show KPI tiles & charts ONLY on Dashboard tab
──────────────────────────────────────────── */
#dashboard:not(.active) .stats-grid,
#dashboard:not(.active) .dashboard-grid,
#dashboard:not(.active) .chart-card{
display: none !important;
}
/* ─── ROI section alignment helpers ─────────────────────────────── */
.roi-two-col{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:30px;
    margin-top:20px;
    align-items:stretch;   /* equal height boxes */
}

.info-box{
    background:#ffffff;
    border:1px solid #e8ebf0;
    border-radius:10px;
    padding:20px;
    box-shadow:0 2px 6px rgba(0,0,0,.04);
    height:100%;
}
.info-box.formula{ border-left:4px solid #2d3436; }
.info-box.ml     { border-left:4px solid #48bb78; }

#shapModelAnalysis{                        /* give SHAP card same look */
    background:#ffffff!important;
    border:1px solid #e8ebf0!important;
    border-radius:15px!important;
}

</style>

</head>
<body>
    <div class="container">
        <div class="header">
            <img src="./greymatter_materials/greymatter_png.png"
                 alt="greymatter" class="logo">
        
            <h1>Influencer ROI Dashboard</h1>
            <p>Advanced Analytics &amp; Campaign Management Platform</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-bar"></i> Dashboard
            </button>
            <button class="tab-button" onclick="switchTab('influencers')">
                <i class="fas fa-users"></i> Influencers
            </button>
            <button class="tab-button" onclick="switchTab('input')">
                <i class="fas fa-plus-circle"></i> Input Campaign
            </button>
        </div>

       <!-- ░░ Dashboard Tab ░░ -->
<div id="dashboard" class="tab-content active">

    <!-- ROI Calculation & Machine Learning -->
<div class="chart-card" style="margin-bottom:30px;">
    <h3><i class="fas fa-calculator"></i> ROI Calculation &amp; Machine Learning</h3>

    <div class="roi-two-col">
        <!-- ░ ROI★ formula ░ -->
        <div class="info-box formula">
            <h4 style="color:#2d3436;margin-bottom:15px;">ROI★ Formula</h4>
            <div style="font-family:'Courier New',monospace;font-size:1rem;color:#2d3436;line-height:1.6;">
                <strong>ROI★ = (ES×0.19 + RS×0.171 + AS×0.157 + QS×0.12 + MS×0.10 + IS×0.08 + CE×0.06 + CF×0.05) × 1000</strong>
            </div>
            <div style="margin-top:15px;font-size:0.9rem;color:#636e72;">
                <strong>ML-Guided Formula&nbsp;(LightGBM feature importance):</strong><br>
                • ES = Engagement Score (ER × 19%) <span style="color:#48bb78;">Highest Impact</span><br>
                • RS = Reach Score (Avg_Reels_View/1M × 17.1%) <span style="color:#48bb78;">High Impact</span><br>
                • AS = Audience Size (Followers/1M × 15.7%) <span style="color:#48bb78;">High Impact</span><br>
                • QS = Quality Score (Quality_Audience/100K × 12%)<br>
                • MS = Market Score (Turkey/100 × 10%)<br>
                • IS = Influence Score (Score/100 × 8%)<br>
                • CE = Comment Engagement (Comment_Rate × 6%)<br>
                • CF = Cost Factor (100K/Est_Post_Price × 5%)<br>
                <small style="color:#4299e1;">Percentages reflect LightGBM feature importance</small>
            </div>
        </div>

        <!-- ░ Machine-Learning enhancement ░ -->
        <div class="info-box ml" id="mlEnhancementSection">
            <div style="text-align:center;color:#636e72;">
                <i class="fas fa-spinner fa-spin"></i> Loading ML model information...
            </div>
        </div>
    </div><!-- /.roi-two-col -->

    <!-- ░ SHAP / Feature-importance card ░ -->
    <div style="margin-top:30px;">
        <h4 style="color:#2d3436;margin-bottom:15px;text-align:center;">
            LightGBM Model Feature Importance
        </h4>
        <div id="shapModelAnalysis" style="padding:30px;max-width:1000px;margin:0 auto;">
            <div style="text-align:center;color:#636e72;padding:50px;">
                <i class="fas fa-spinner fa-spin"></i> Loading model feature importance analysis...
            </div>
        </div>
    </div>
</div><!-- /.chart-card -->



    <!-- ░ KPI tiles ░ -->
    <div class="stats-grid">
        <div class="stat-card grey">
            <div class="stat-value" id="totalInfluencers">-</div>
            <div class="stat-label">Total Influencers</div>
        </div>
        <div class="stat-card green">
            <div class="stat-value" id="avgROI">-</div>
            <div class="stat-label">Average ROI</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-value" id="topROI">-</div>
            <div class="stat-label">Top ROI Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgEngagement">-</div>
            <div class="stat-label">Avg Engagement %</div>
        </div>
    </div>


    <!-- ░ Dashboard charts ░ -->
    <div class="dashboard-grid">
        <!-- Top-10 bar chart -->
        <div class="chart-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="margin:0;"><i class="fas fa-fire"></i> Top 10 Influencers</h3>
                <select id="topInfluencersTierFilter" onchange="updateTopInfluencersChart()"
                        style="padding:5px 10px;border-radius:5px;border:1px solid #e8ebf0;font-size:0.9rem;">
                    <option value="">All Tiers</option>
                </select>
            </div>
            <canvas id="topInfluencersChart"></canvas>
        </div>

        <!-- Heat-map chart -->
        <div class="chart-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="margin:0;"><i class="fas fa-map"></i> Engagement vs Followers Heatmap</h3>
                <select id="heatmapTierFilter" onchange="updateHeatmapChart()"
                        style="padding:5px 10px;border-radius:5px;border:1px solid #e8ebf0;font-size:0.9rem;">
                    <option value="">All Tiers</option>
                </select>
            </div>
            <div id="heatmapChart" style="height:400px;"></div>
        </div>
    </div>

</div><!-- ░░ end #dashboard ░░ -->

        <!-- Influencers Tab -->
        <div id="influencers" class="tab-content">
            <div class="loading" id="tableLoading">
                <div class="spinner"></div>
                <p>Loading influencer data...</p>
            </div>
            
            <div id="influencerData" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="limitSelect" style="font-weight: 500; color: #2d3436;">Show top:</label>
                        <select id="limitSelect" onchange="updateInfluencerLimit()" 
                                style="padding: 8px 12px; border-radius: 8px; border: 2px solid #e8ebf0; background: white; font-size: 0.9rem; min-width: 100px;">
                            <option value="" selected>All (1000+)</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                        </select>
                        
                        <label for="categorySelect" style="font-weight: 500; color: #2d3436;">Category:</label>
                        <select id="categorySelect" onchange="updateCategoryFilter()" 
                                style="padding: 8px 12px; border-radius: 8px; border: 2px solid #e8ebf0; background: white; font-size: 0.9rem; min-width: 120px;">
                            <option value="">All Categories</option>
                        </select>
                        
                        <label for="tierSelect" style="font-weight: 500; color: #2d3436;">Tier:</label>
                        <select id="tierSelect" onchange="updateTierFilter()" 
                                style="padding: 8px 12px; border-radius: 8px; border: 2px solid #e8ebf0; background: white; font-size: 0.9rem; min-width: 100px;">
                            <option value="">All Tiers</option>
                        </select>
                        
                        <span id="resultCount" style="color: #636e72; font-size: 0.9rem;"></span>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search influencers..." 
                           style="padding: 10px 15px; border-radius: 8px; border: 2px solid #e8ebf0; width: 300px; font-size: 0.9rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                    <div>
                        <table class="influencer-table" id="influencerTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)">Account <i class="fas fa-sort sort-icon"></i></th>
                                    <th onclick="sortTable(1)">ROI Score <i class="fas fa-sort sort-icon"></i></th>
                                    <th onclick="sortTable(2)">Followers <i class="fas fa-sort sort-icon"></i></th>
                                    <th onclick="sortTable(3)">Engagement % <i class="fas fa-sort sort-icon"></i></th>
                                    <th onclick="sortTable(4)">Post Price <i class="fas fa-sort sort-icon"></i></th>
                                    <th onclick="sortTable(5)">Turkey % <i class="fas fa-sort sort-icon"></i></th>
                                </tr>
                            </thead>
                            <tbody id="influencerTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="chart-card" style="height: fit-content;">
                        <h3><i class="fas fa-analytics"></i> Influencer Analysis</h3>
                        <p style="color: #636e72; font-size: 0.9rem; margin-bottom: 15px;">Click on an influencer to see detailed ROI breakdown</p>
                        <div id="analysisChart" style="min-height: 400px; display: flex; align-items: center; justify-content: center; color: #636e72;">
                            Select an influencer to view detailed analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Tab -->
        <div id="input" class="tab-content">
            <div class="alert success" id="successAlert">
                <i class="fas fa-check-circle"></i> Campaign data added successfully!
            </div>
            <div class="alert error" id="errorAlert">
                <i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
            </div>

            <h2 style="margin-bottom: 30px; color: #4a5568;">
                <i class="fas fa-plus-circle"></i> Add Campaign Results & ML Training Data
            </h2>
            
            <form id="campaignForm">
                <!-- Pre-Campaign Data Section -->
                <div style="background: #f8f9fc; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #4299e1;">
                    <h4 style="color: #2d3436; margin-bottom: 15px;"><i class="fas fa-user"></i> Influencer Profile Data</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="account">Account Name</label>
                            <input type="text" id="account" name="account" placeholder="@username" required>
                        </div>
                        <div class="form-group">
                            <label for="followers">Followers</label>
                            <input type="number" id="followers" name="followers" placeholder="100000" required>
                        </div>
                        <div class="form-group">
                            <label for="qualityAudience">Quality Audience</label>
                            <input type="number" id="qualityAudience" name="qualityAudience" placeholder="90000" required>
                        </div>
                        <div class="form-group">
                            <label for="avgReelsView">Historical Avg Reels View</label>
                            <input type="number" id="avgReelsView" name="avgReelsView" placeholder="50000" required>
                        </div>
                        <div class="form-group">
                            <label for="turkey">Turkey Market (%)</label>
                            <input type="number" id="turkey" name="turkey" min="0" max="100" placeholder="75" required>
                        </div>
                        <div class="form-group">
                            <label for="score">Influence Score</label>
                            <input type="number" id="score" name="score" min="0" max="100" placeholder="90" required>
                        </div>
                    </div>
                </div>

                <!-- Campaign Performance Data Section -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #48bb78;">
                    <h4 style="color: #2d3436; margin-bottom: 15px;"><i class="fas fa-chart-line"></i> Post-Campaign Performance Metrics</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="sponsoredReelsView">Sponsored Reels Views</label>
                            <input type="number" id="sponsoredReelsView" name="sponsoredReelsView" placeholder="75000" required>
                        </div>
                        <div class="form-group">
                            <label for="campaignEngagementRate">Campaign Engagement Rate (%)</label>
                            <input type="number" id="campaignEngagementRate" name="campaignEngagementRate" step="0.01" placeholder="6.25" required>
                        </div>
                        <div class="form-group">
                            <label for="campaignReach">Campaign Reach</label>
                            <input type="number" id="campaignReach" name="campaignReach" placeholder="120000" required>
                        </div>
                        <div class="form-group">
                            <label for="actualCost">Actual Campaign Cost ($)</label>
                            <input type="number" id="actualCost" name="actualCost" placeholder="1200" required>
                        </div>
                        <div class="form-group">
                            <label for="linkClicks">Link Clicks (if applicable)</label>
                            <input type="number" id="linkClicks" name="linkClicks" placeholder="2500" min="0">
                        </div>
                        <div class="form-group">
                            <label for="commentRate">Comment Rate</label>
                            <input type="number" id="commentRate" name="commentRate" step="0.01" placeholder="0.15" required>
                        </div>
                    </div>
                    
                    <!-- Calculated Metrics Display -->
                    <div style="margin-top: 15px; padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 8px;">
                        <h6 style="color: #2d3436; margin-bottom: 10px;">Calculated Performance Metrics:</h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div>📊 <strong>Performance Ratio:</strong> <span id="performanceRatio">-</span></div>
                            <div>💰 <strong>Cost per Reach:</strong> <span id="costPerReach">-</span></div>
                            <div>🎯 <strong>Cost per Click:</strong> <span id="costPerClick">-</span></div>
                            <div>⭐ <strong>Predicted ROI:</strong> <span id="predictedRoi">-</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category">Category</label>
                    <textarea id="category" name="category" rows="3" placeholder="Entertainment, Funny Videos, Movies & TV Shows..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="interests">Interests (format: Interest : 50%, Interest2 : 30%)</label>
                    <textarea id="interests" name="interests" rows="4" placeholder="Entertainment : 68%, Film & Television : 45%, Fashion : 32%" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="score">Score</label>
                    <input type="number" id="score" name="score" min="0" max="100" placeholder="90" required>
                </div>
                
                <button type="submit" class="btn">
                    <i class="fas fa-save"></i> Add Campaign Data
                </button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let influencerData = [];
        let sortDirection = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadInfluencerData(null); // Load all influencers initially
            loadCategories();
            loadTiers();
            loadMLInfo();
            loadModelFeatureImportance();
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Explicitly hide dashboard charts when switching away from dashboard
            if (tabName !== 'dashboard') {
                const dashboardGrid = document.querySelector('#dashboard .dashboard-grid');
                const statsGrid = document.querySelector('#dashboard .stats-grid');
                const dashboardChartCards = document.querySelectorAll('#dashboard .chart-card');
                
                if (dashboardGrid) dashboardGrid.style.display = 'none';
                if (statsGrid) statsGrid.style.display = 'none';
                dashboardChartCards.forEach(card => card.style.display = 'none');
            }
            
            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data and show charts if switching to dashboard
            if (tabName === 'dashboard') {
                // Re-show dashboard elements
                const dashboardGrid = document.querySelector('#dashboard .dashboard-grid');
                const statsGrid = document.querySelector('#dashboard .stats-grid');
                const dashboardChartCards = document.querySelectorAll('#dashboard .chart-card');
                
                if (dashboardGrid) dashboardGrid.style.display = 'grid';
                if (statsGrid) statsGrid.style.display = 'grid';
                dashboardChartCards.forEach(card => card.style.display = 'block');
                
                updateDashboard();
            }
        }

        // Load influencer data from backend API
        async function loadInfluencerData(limit = null, category = '', tier = '') {
            try {
                console.log('Fetching data from API with limit:', limit, 'category:', category, 'tier:', tier);
                const baseUrl = window.location.origin;
                
                // Build URL with parameters
                let url = `${baseUrl}/api/influencers`;
                const params = new URLSearchParams();
                if (limit) params.append('limit', limit);
                if (category) params.append('category', category);
                if (tier) params.append('tier', tier);
                if (params.toString()) url += '?' + params.toString();
                
                console.log('API URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                influencerData = await response.json();
                console.log('API response received:', influencerData.length, 'records');
                if (influencerData.length > 0) {
                    console.log('Sample record:', influencerData[0]);
                }
                
                if (influencerData.error) {
                    throw new Error(influencerData.error);
                }
                
                updateDashboard();
                updateInfluencerTable();
                updateResultCount();
                
                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('influencerData').style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                console.log('Falling back to sample data...');
                // Fallback to sample data if API fails
                influencerData = generateSampleData();
                updateDashboard();
                updateInfluencerTable();
                updateResultCount();
                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('influencerData').style.display = 'block';
            }
        }

        // Update influencer limit
        function updateInfluencerLimit() {
            const limit = document.getElementById('limitSelect').value;
            const category = document.getElementById('categorySelect').value;
            const tier = document.getElementById('tierSelect').value;
            const numLimit = limit ? parseInt(limit) : null;
            loadInfluencerData(numLimit, category, tier);
        }

        // Update category filter
        function updateCategoryFilter() {
            const limit = document.getElementById('limitSelect').value;
            const category = document.getElementById('categorySelect').value;
            const tier = document.getElementById('tierSelect').value;
            const numLimit = limit ? parseInt(limit) : null;
            loadInfluencerData(numLimit, category, tier);
        }

        // Update tier filter
        function updateTierFilter() {
            const limit = document.getElementById('limitSelect').value;
            const category = document.getElementById('categorySelect').value;
            const tier = document.getElementById('tierSelect').value;
            const numLimit = limit ? parseInt(limit) : null;
            loadInfluencerData(numLimit, category, tier);
        }

        // Load available categories from API
        async function loadCategories() {
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/categories`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const categoryData = await response.json();
                const categorySelect = document.getElementById('categorySelect');
                
                // Clear existing options except "All Categories"
                categorySelect.innerHTML = '<option value="">All Categories</option>';
                
                // Add categories to dropdown
                categoryData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = `${category} (${categoryData.category_counts[category]})`;
                    categorySelect.appendChild(option);
                });
                
                console.log('Loaded', categoryData.categories.length, 'categories');
            } catch (error) {
                console.error('Error loading categories:', error);
                // Keep the dropdown with just "All Categories" option
            }
        }

        // Load available tiers from API
        async function loadTiers() {
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/tiers`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const tierData = await response.json();
                
                // Populate main tier filter
                const tierSelect = document.getElementById('tierSelect');
                tierSelect.innerHTML = '<option value="">All Tiers</option>';
                
                tierData.tiers.forEach(tier => {
                    const option = document.createElement('option');
                    option.value = tier;
                    option.textContent = `${tier} (${tierData.tier_counts[tier]}) - ${tierData.tier_definitions[tier]}`;
                    tierSelect.appendChild(option);
                });
                
                // Populate chart tier filters
                const topTierFilter = document.getElementById('topInfluencersTierFilter');
                const heatmapTierFilter = document.getElementById('heatmapTierFilter');
                
                [topTierFilter, heatmapTierFilter].forEach(filter => {
                    if (filter) {
                        filter.innerHTML = '<option value="">All Tiers</option>';
                        tierData.tiers.forEach(tier => {
                            const option = document.createElement('option');
                            option.value = tier;
                            option.textContent = `${tier} (${tierData.tier_counts[tier]})`;
                            filter.appendChild(option);
                        });
                    }
                });
                
                console.log('Loaded', tierData.tiers.length, 'tiers');
            } catch (error) {
                console.error('Error loading tiers:', error);
            }
        }

        // Update top influencers chart with tier filter
        function updateTopInfluencersChart() {
            const tier = document.getElementById('topInfluencersTierFilter').value;
            // Filter data and recreate chart
            let filteredData = influencerData;
            if (tier) {
                filteredData = influencerData.filter(item => item.tier === tier);
            }
            createTopInfluencersChart(filteredData);
        }

        // Update heatmap chart with tier filter
        function updateHeatmapChart() {
            const tier = document.getElementById('heatmapTierFilter').value;
            // Filter data and recreate chart
            let filteredData = influencerData;
            if (tier) {
                filteredData = influencerData.filter(item => item.tier === tier);
            }
            createHeatmap(filteredData);
        }

        // Update result count display
        function updateResultCount() {
            const count = influencerData.length;
            const limit = document.getElementById('limitSelect').value;
            const category = document.getElementById('categorySelect').value;
            const tier = document.getElementById('tierSelect').value;
            let text = `Showing ${count} influencers`;
            if (limit) {
                text += ` (top ${limit})`;
            }
            if (category) {
                text += ` in "${category}"`;
            }
            if (tier) {
                text += ` in "${tier}" tier`;
            }
            document.getElementById('resultCount').textContent = text;
        }

        // Load ML model information dynamically
        async function loadMLInfo() {
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/ml-info`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const mlData = await response.json();
                const mlSection = document.getElementById('mlEnhancementSection');
                
                if (mlData.ml_enabled) {
                    // ML model is active
                    mlSection.innerHTML = `
                        <p style="margin-bottom: 10px; color: #2d3436;">Our ML algorithm continuously learns from campaign data:</p>
                        <ul style="color: #636e72; line-height: 1.6;">
                            <li><strong>${mlData.model_type}:</strong> Predicts ROI with ${mlData.validation_accuracy}% accuracy</li>
                            <li><strong>Feature Analysis:</strong> SHAP values identify key drivers</li>
                            <li><strong>Data Integration:</strong> New campaigns improve predictions</li>
                            <li><strong>Real-time Updates:</strong> Algorithm refines with each input</li>
                            <li><strong>Statistical Significance:</strong> ${mlData.is_statistically_significant ? '✅ Validated' : '❌ Not significant'} (p=${mlData.statistical_significance_p.toFixed(6)})</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(72, 187, 120, 0.1); border-radius: 5px;">
                            <small style="color: #2d3436;"><strong>Model Performance:</strong> Training R² = ${mlData.training_accuracy}%, Validation R² = ${mlData.validation_accuracy}%</small>
                            <br><small style="color: #636e72;">Cross-Validation: ${mlData.cross_validation_mean}% ± ${mlData.cross_validation_std}% | Features: ${mlData.feature_count}</small>
                        </div>
                    `;
                } else {
                    // Fallback to mathematical formula
                    mlSection.innerHTML = `
                        <p style="margin-bottom: 10px; color: #2d3436;">Currently using mathematical ROI calculation:</p>
                        <ul style="color: #636e72; line-height: 1.6;">
                            <li><strong>Formula:</strong> (Quality × Engagement × Market × (1 + 0.2×Comments)) / Price</li>
                            <li><strong>Status:</strong> ${mlData.fallback_method}</li>
                            <li><strong>Note:</strong> Train ML model with 'python3 train_ml_model.py' for predictions</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(251, 146, 60, 0.1); border-radius: 5px;">
                            <small style="color: #2d3436;"><strong>Status:</strong> ML model not available - using mathematical formula</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading ML info:', error);
                document.getElementById('mlEnhancementSection').innerHTML = `
                    <div style="color: #e74c3c; text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> Error loading ML model information
                    </div>
                `;
            }
        }

        // Load model-level feature importance analysis
        async function loadModelFeatureImportance() {
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/model-feature-importance`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const importanceData = await response.json();
                
                if (importanceData.success) {
                    createModelFeatureImportancePlot(importanceData);
                } else {
                    throw new Error(importanceData.error);
                }
            } catch (error) {
                console.error('Error loading model feature importance:', error);
                document.getElementById('shapModelAnalysis').innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 50px;">
                        <i class="fas fa-exclamation-triangle"></i> Error loading model feature importance
                        <br><small>ML model not available - using mathematical ROI calculation</small>
                    </div>
                `;
            }
        }

        // Create model feature importance visualization
        function createModelFeatureImportancePlot(importanceData) {
            const plotDiv = document.getElementById('shapModelAnalysis');
            const features = importanceData.feature_importance;
            const modelSummary = importanceData.model_summary;
            const sampleStats = importanceData.sample_statistics;
            
            // Create comprehensive model analysis visualization
            plotDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h5 style="color: #2d3436; margin: 0; font-size: 1.3rem;">LightGBM Model Feature Importance Analysis</h5>
                    <p style="color: #636e72; margin: 5px 0; font-size: 0.95rem;">${importanceData.explanation}</p>
                    <div style="margin-top: 10px; padding: 10px; background: #f0fff4; border-radius: 8px; display: inline-block;">
                        <strong style="color: #2d3436;">Model Performance: ${(modelSummary.validation_accuracy * 100).toFixed(1)}% Validation Accuracy</strong>
                        <span style="color: #636e72; margin-left: 15px;">Top Features: ${modelSummary.top_3_features.join(', ')}</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
                    <!-- Feature Importance Chart -->
                    <div>
                        <h6 style="color: #2d3436; margin-bottom: 15px; text-align: center;">Feature Importance Rankings</h6>
                        <canvas id="featureImportanceChart" width="400" height="350"></canvas>
                    </div>
                    
                    <!-- Feature Details -->
                    <div>
                        <h6 style="color: #2d3436; margin-bottom: 15px; text-align: center;">Feature Impact Details</h6>
                        <div style="max-height: 350px; overflow-y: auto;">
                            ${features.map((feature, index) => `
                                <div style="margin-bottom: 12px; padding: 12px; background: linear-gradient(to right, rgba(72, 187, 120, ${0.1 + (feature.importance_normalized / 100) * 0.3}), rgba(72, 187, 120, 0.05)); border-radius: 8px; border-left: 4px solid #48bb78;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <strong style="color: #2d3436; font-size: 0.95rem;">#${index + 1} ${feature.feature.replace(/_/g, ' ')}</strong>
                                        <span style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                            ${feature.importance_normalized.toFixed(1)}%
                                        </span>
                                    </div>
                                    ${sampleStats[feature.feature] ? `
                                        <div style="font-size: 0.8rem; color: #636e72; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                            <span>Avg: ${sampleStats[feature.feature].mean.toFixed(1)}</span>
                                            <span>Range: ${sampleStats[feature.feature].min.toFixed(0)}-${sampleStats[feature.feature].max.toFixed(0)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Model Insights -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9fc 0%, #e8ebf0 100%); border-radius: 10px;">
                    <h6 style="color: #2d3436; margin-bottom: 15px; text-align: center;">Key Model Insights</h6>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #48bb78;">${features.length}</div>
                            <div style="font-size: 0.9rem; color: #636e72;">Total Features</div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #48bb78;">${features[0].importance_normalized.toFixed(1)}%</div>
                            <div style="font-size: 0.9rem; color: #636e72;">Top Feature Impact</div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #48bb78;">${features.slice(0, 3).reduce((sum, f) => sum + f.importance_normalized, 0).toFixed(1)}%</div>
                            <div style="font-size: 0.9rem; color: #636e72;">Top 3 Combined</div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #48bb78;">${(modelSummary.validation_accuracy * 100).toFixed(1)}%</div>
                            <div style="font-size: 0.9rem; color: #636e72;">Model Accuracy</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create Chart.js feature importance chart
            setTimeout(() => {
                const ctx = document.getElementById('featureImportanceChart');
                if (ctx) {
                    // Generate colors based on importance
                    const colors = features.map((_, index) => {
                        const intensity = 1 - (index / features.length) * 0.6; // Fade from full to 40%
                        return `rgba(72, 187, 120, ${intensity})`;
                    });
                    
                    const chart = new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: features.map(f => f.feature.replace(/_/g, ' ')),
                            datasets: [{
                                label: 'Feature Importance (%)',
                                data: features.map(f => f.importance_normalized),
                                backgroundColor: colors,
                                borderColor: colors.map(c => c.replace(/[^,]+(?=\))/, '1')), // Full opacity for borders
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'LightGBM Feature Importance',
                                    font: { size: 14, weight: 'bold' }
                                },
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.label}: ${context.parsed.y.toFixed(1)}% importance`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Importance (%)'
                                    },
                                    grid: { color: '#e8ebf0' },
                                    beginAtZero: true
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        font: { size: 11 }
                                    },
                                    grid: { color: '#e8ebf0' }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }
            }, 100);
        }

        // Generate sample data (fallback if API fails)
        function generateSampleData() {
            console.log("WARNING: Using fallback sample data - API connection failed");
            const accounts = ['@simayrie', '@aniluzsen', '@asenaaolgun', '@hamzaibac', '@ereyavu1'];
            const data = [];
            
            // Create a smaller sample since we have real data
            for (let i = 0; i < 20; i++) {
                const followers = Math.floor(Math.random() * 1000000) + 50000;
                const qualityAudience = Math.floor(followers * (0.7 + Math.random() * 0.25));
                const er = Math.random() * 30 + 5;
                const turkey = Math.floor(Math.random() * 40) + 60;
                const postPrice = Math.floor(Math.random() * 5000) + 200;
                const commentRate = Math.random() * 0.3;
                
                const roi = (qualityAudience * er * (turkey/100) * 1.0 * (1 + 0.2*commentRate)) / postPrice;
                
                data.push({
                    account: i < 5 ? accounts[i] : `@user${i}`,
                    roi: Math.round(roi),
                    followers: followers,
                    engagement: Math.round(er * 100) / 100,
                    postPrice: postPrice,
                    turkey: turkey,
                    qualityAudience: qualityAudience,
                    commentRate: Math.round(commentRate * 100) / 100
                });
            }
            
            return data.sort((a, b) => b.roi - a.roi);
        }

        // Update dashboard statistics and charts
        function updateDashboard() {
            if (influencerData.length === 0) return;
            
            // Update statistics
            document.getElementById('totalInfluencers').textContent = influencerData.length;
            document.getElementById('avgROI').textContent = Math.round(influencerData.reduce((sum, item) => sum + item.roi, 0) / influencerData.length);
            document.getElementById('topROI').textContent = Math.max(...influencerData.map(item => item.roi));
            document.getElementById('avgEngagement').textContent = (influencerData.reduce((sum, item) => sum + item.engagement, 0) / influencerData.length).toFixed(1) + '%';
            
            // Create charts
            createTopInfluencersChart();
            createHeatmap();
        }


        // Create top influencers chart
        function createTopInfluencersChart(filteredData = null) {
            const ctx = document.getElementById('topInfluencersChart');
            if (!ctx) return;
            
            // Use provided filtered data or fall back to global data
            const dataToUse = filteredData || influencerData;
            
            // Handle empty data case
            if (!dataToUse || dataToUse.length === 0) {
                // Clear existing chart and show message
                if (window.topInfluencersChartInstance) {
                    window.topInfluencersChartInstance.destroy();
                    window.topInfluencersChartInstance = null;
                }
                ctx.style.display = 'none';
                ctx.parentElement.innerHTML += '<div id="noTopInfluencersData" style="text-align: center; color: #636e72; padding: 50px;">No influencers available for selected filters</div>';
                return;
            }
            
            // Show canvas and remove no-data message if it exists
            ctx.style.display = 'block';
            const noDataMsg = document.getElementById('noTopInfluencersData');
            if (noDataMsg) {
                noDataMsg.remove();
            }
            
            const top10 = dataToUse.slice(0, 10);
            
            // Destroy existing chart if it exists
            if (window.topInfluencersChartInstance) {
                window.topInfluencersChartInstance.destroy();
            }
            
            window.topInfluencersChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(item => item.account),
                    datasets: [{
                        label: 'ROI Score',
                        data: top10.map(item => item.roi),
                        backgroundColor: '#2d3436',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Create heatmap
        function createHeatmap(filteredData = null) {
            const heatmapDiv = document.getElementById('heatmapChart');
            if (!heatmapDiv) return;
            
            // Use provided filtered data or fall back to global data
            const dataToUse = filteredData || influencerData;
            
            // Handle empty data case
            if (!dataToUse || dataToUse.length === 0) {
                heatmapDiv.innerHTML = '<div style="text-align: center; color: #636e72; padding: 50px;">No data available for selected filters</div>';
                return;
            }
            
            const trace = {
                x: dataToUse.map(item => item.followers),
                y: dataToUse.map(item => item.engagement),
                z: dataToUse.map(item => item.roi),
                type: 'scatter',
                mode: 'markers',
                marker: {
                    size: 8,
                    color: dataToUse.map(item => item.roi),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'ROI Score'
                    }
                },
                text: dataToUse.map(item => item.account),
                hovertemplate: '%{text}<br>Followers: %{x}<br>Engagement: %{y}%<br>ROI: %{z}<extra></extra>'
            };
            
            const layout = {
                xaxis: { title: 'Followers' },
                yaxis: { title: 'Engagement Rate (%)' },
                margin: { t: 0, r: 0, b: 40, l: 50 }
            };
            
            Plotly.newPlot('heatmapChart', [trace], layout, { responsive: true });
        }

        // Update influencer table
        function updateInfluencerTable() {
            const tbody = document.getElementById('influencerTableBody');
            tbody.innerHTML = '';
            
            influencerData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => loadInfluencerAnalysis(item.account);
                row.innerHTML = `
                    <td><span class="account-name">${item.account}</span></td>
                    <td><span class="roi-score">${item.roi}</span></td>
                    <td>${item.followers.toLocaleString()}</td>
                    <td>${item.engagement}%</td>
                    <td>$${item.postPrice.toLocaleString()}</td>
                    <td>${item.turkey}%</td>
                `;
            });
        }

        // Load comprehensive influencer analysis
        async function loadInfluencerAnalysis(account) {
            try {
                console.log('Loading influencer analysis for:', account);
                const baseUrl = window.location.origin;
                const url = `${baseUrl}/api/influencer-analysis/${encodeURIComponent(account)}`;
                console.log('Analysis API URL:', url);
                
                const response = await fetch(url);
                console.log('Analysis response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const analysisData = await response.json();
                console.log('Analysis data received:', analysisData);
                displayInfluencerAnalysis(analysisData);
            } catch (error) {
                console.error('Error loading influencer analysis:', error);
                document.getElementById('analysisChart').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i><br>
                        <strong>Error loading analysis</strong><br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Display comprehensive influencer analysis
        function displayInfluencerAnalysis(data) {
            const chartDiv = document.getElementById('analysisChart');
            
            // Clear any existing content
            chartDiv.innerHTML = '';
            
            if (!data.success) {
                chartDiv.innerHTML = `<div style="color: #e74c3c; text-align: center;">Error: ${data.error}</div>`;
                return;
            }
            
            const influencer = data.influencer_data;
            const decision = data.decision_tree;
            const averages = data.dataset_averages;
            
            // Create comprehensive analysis display
            const analysisHtml = `
                <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); color: white; border-radius: 10px;">
                        <h2 style="margin: 0; font-size: 1.5rem;">@${influencer.account}</h2>
                        <div style="font-size: 2rem; font-weight: bold; margin: 5px 0;">ROI: ${decision.final_roi.toLocaleString()}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${decision.roi_category} Performance (${decision.vs_average_roi > 0 ? '+' : ''}${decision.vs_average_roi}% vs avg)</div>
                    </div>

                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <div style="background: #f8f9fc; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2d3436;">${influencer.followers.toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: #636e72;">Total Followers</div>
                        </div>
                        <div style="background: #f8f9fc; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2d3436;">${influencer.engagement_rate}%</div>
                            <div style="font-size: 0.8rem; color: #636e72;">Engagement Rate</div>
                        </div>
                        <div style="background: #f8f9fc; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2d3436;">$${influencer.post_price.toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: #636e72;">Post Price</div>
                        </div>
                        <div style="background: #f8f9fc; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2d3436;">${influencer.turkey_market}%</div>
                            <div style="font-size: 0.8rem; color: #636e72;">Turkey Market</div>
                        </div>
                    </div>

                    <!-- ML-Guided ROI Calculation -->
                    <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3436;"><i class="fas fa-brain"></i> ML-Guided ROI Calculation</h4>
                        <div style="font-size: 0.85rem; margin-bottom: 10px; color: #636e72;">Based on LightGBM Feature Importance Analysis</div>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.4;">
                            <div>1. Engagement Score (${influencer.engagement_rate}% × 19%): <strong>${((influencer.engagement_rate * 0.19) * 1000).toFixed(0)}</strong></div>
                            <div>2. Reach Score (${(influencer.avg_reels_view / 1000000).toFixed(1)}M × 17.1%): <strong>${((influencer.avg_reels_view / 1000000 * 0.171) * 1000).toFixed(0)}</strong></div>
                            <div>3. Audience Size (${(influencer.followers / 1000000).toFixed(1)}M × 15.7%): <strong>${((influencer.followers / 1000000 * 0.157) * 1000).toFixed(0)}</strong></div>
                            <div>4. Quality Score (${influencer.quality_audience}K × 12%): <strong>${((influencer.quality_audience / 100000 * 0.12) * 1000).toFixed(0)}</strong></div>
                            <div>5. Market Score (${influencer.turkey_market}% × 10%): <strong>${((influencer.turkey_market / 100 * 0.10) * 1000).toFixed(0)}</strong></div>
                            <div>6. Influence Score (${influencer.score} × 8%): <strong>${((influencer.score / 100 * 0.08) * 1000).toFixed(0)}</strong></div>
                            <div>7. Comment Engagement (${influencer.comment_rate}% × 6%): <strong>${((influencer.comment_rate * 0.06) * 1000).toFixed(0)}</strong></div>
                            <div>8. Cost Efficiency (100K/$${influencer.post_price.toLocaleString()} × 5%): <strong>${((100000 / Math.max(influencer.post_price, 1) * 0.05) * 1000).toFixed(0)}</strong></div>
                            <div style="border-top: 1px solid #48bb78; margin-top: 10px; padding-top: 10px;">
                                <strong style="color: #48bb78; font-size: 1.1em;">Final ML ROI★: ${decision.final_roi.toLocaleString()}</strong>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 0.8rem; color: #2d3436;">
                            <strong>ML Model:</strong> LightGBM (95.8% accuracy) • <strong>Weights:</strong> Based on feature importance analysis of ${influencer.followers > 2000000 ? 'Star' : influencer.followers > 500000 ? 'Macro' : influencer.followers > 100000 ? 'Mid' : influencer.followers > 10000 ? 'Micro' : 'Nano'} tier influencers
                        </div>
                    </div>

                    <!-- ML Feature Importance Contributors -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #2d3436;"><i class="fas fa-brain"></i> ML Feature Importance Impact</h4>
                        <div style="font-size: 0.8rem; color: #636e72; margin-bottom: 15px;">How each feature contributes to the ML model's ROI prediction based on LightGBM analysis</div>
                        
                        <!-- Top 3 Most Important Features with Performance Highlighting -->
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 12px; background: ${influencer.engagement_rate >= averages.engagement_rate ? '#f0fff4' : '#fef2f2'}; border-radius: 8px; border-left: 4px solid ${influencer.engagement_rate >= averages.engagement_rate ? '#48bb78' : '#e74c3c'};">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${influencer.engagement_rate >= averages.engagement_rate ? '#2d3436' : '#e74c3c'};">Engagement Rate (ER)</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Highest ML importance: ${influencer.engagement_rate}% engagement ${influencer.engagement_rate < averages.engagement_rate ? '(Below Avg: ' + averages.engagement_rate.toFixed(1) + '%)' : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${influencer.engagement_rate >= averages.engagement_rate ? '#48bb78' : '#e74c3c'};">19.0%</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Model Weight</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 12px; background: ${influencer.avg_reels_view >= averages.avg_reels_view ? '#f0fff4' : '#fef2f2'}; border-radius: 8px; border-left: 4px solid ${influencer.avg_reels_view >= averages.avg_reels_view ? '#4299e1' : '#e74c3c'};">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${influencer.avg_reels_view >= averages.avg_reels_view ? '#2d3436' : '#e74c3c'};">Average Reels Views</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Content reach: ${(influencer.avg_reels_view / 1000000).toFixed(1)}M avg views ${influencer.avg_reels_view < averages.avg_reels_view ? '(Below Avg: ' + (averages.avg_reels_view / 1000000).toFixed(1) + 'M)' : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${influencer.avg_reels_view >= averages.avg_reels_view ? '#4299e1' : '#e74c3c'};">17.1%</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Model Weight</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 12px; background: ${influencer.followers >= averages.followers ? '#f0fff4' : '#fef2f2'}; border-radius: 8px; border-left: 4px solid ${influencer.followers >= averages.followers ? '#9f7aea' : '#e74c3c'};">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${influencer.followers >= averages.followers ? '#2d3436' : '#e74c3c'};">Follower Count</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Audience size: ${(influencer.followers / 1000000).toFixed(1)}M followers ${influencer.followers < averages.followers ? '(Below Avg: ' + (averages.followers / 1000000).toFixed(1) + 'M)' : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${influencer.followers >= averages.followers ? '#9f7aea' : '#e74c3c'};">15.7%</div>
                                <div style="font-size: 0.8rem; color: #636e72;">Model Weight</div>
                            </div>
                        </div>
                        
                        <!-- Other Contributing Features with Performance Highlighting -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                            <div style="padding: 8px; background: ${influencer.quality_audience >= averages.quality_audience ? '#f8f9fc' : '#fef2f2'}; border-radius: 6px; text-align: center; border-left: 3px solid ${influencer.quality_audience >= averages.quality_audience ? '#a0aec0' : '#e74c3c'};">
                                <div style="font-size: 0.75rem; color: ${influencer.quality_audience >= averages.quality_audience ? '#636e72' : '#e74c3c'};">Quality Audience</div>
                                <div style="font-weight: bold; color: ${influencer.quality_audience >= averages.quality_audience ? '#2d3436' : '#e74c3c'};">12.0%</div>
                            </div>
                            <div style="padding: 8px; background: ${influencer.turkey_market >= averages.turkey_market ? '#f8f9fc' : '#fef2f2'}; border-radius: 6px; text-align: center; border-left: 3px solid ${influencer.turkey_market >= averages.turkey_market ? '#a0aec0' : '#e74c3c'};">
                                <div style="font-size: 0.75rem; color: ${influencer.turkey_market >= averages.turkey_market ? '#636e72' : '#e74c3c'};">Turkey</div>
                                <div style="font-weight: bold; color: ${influencer.turkey_market >= averages.turkey_market ? '#2d3436' : '#e74c3c'};">10.0%</div>
                            </div>
                            <div style="padding: 8px; background: ${influencer.score >= averages.score ? '#f8f9fc' : '#fef2f2'}; border-radius: 6px; text-align: center; border-left: 3px solid ${influencer.score >= averages.score ? '#a0aec0' : '#e74c3c'};">
                                <div style="font-size: 0.75rem; color: ${influencer.score >= averages.score ? '#636e72' : '#e74c3c'};">Score Rating</div>
                                <div style="font-weight: bold; color: ${influencer.score >= averages.score ? '#2d3436' : '#e74c3c'};">8.0%</div>
                            </div>
                            <div style="padding: 8px; background: ${influencer.comment_rate >= averages.comment_rate ? '#f8f9fc' : '#fef2f2'}; border-radius: 6px; text-align: center; border-left: 3px solid ${influencer.comment_rate >= averages.comment_rate ? '#a0aec0' : '#e74c3c'};">
                                <div style="font-size: 0.75rem; color: ${influencer.comment_rate >= averages.comment_rate ? '#636e72' : '#e74c3c'};">Comment Rate</div>
                                <div style="font-weight: bold; color: ${influencer.comment_rate >= averages.comment_rate ? '#2d3436' : '#e74c3c'};">6.0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Categories & Interests -->
                    ${influencer.category ? `
                        <div style="background: #fff7ed; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #fb923c;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3436;"><i class="fas fa-tags"></i> Categories</h4>
                            <div style="font-size: 0.9rem; color: #636e72;">${influencer.category}</div>
                        </div>
                    ` : ''}
                    
                    ${influencer.interests ? `
                        <div style="background: #f3e8ff; padding: 15px; border-radius: 10px; border-left: 4px solid #a855f7;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3436;"><i class="fas fa-heart"></i> Top Interests</h4>
                            <div style="font-size: 0.9rem; color: #636e72; line-height: 1.4;">${influencer.interests.split(',').slice(0, 5).join(', ')}${influencer.interests.split(',').length > 5 ? '...' : ''}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            chartDiv.innerHTML = analysisHtml;
        }

        // Sort table
        function sortTable(columnIndex) {
            const table = document.getElementById('influencerTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            const isAscending = sortDirection[columnIndex] !== 'asc';
            sortDirection[columnIndex] = isAscending ? 'asc' : 'desc';
            
            rows.sort((a, b) => {
                const aValue = getCellValue(a, columnIndex);
                const bValue = getCellValue(b, columnIndex);
                
                if (isAscending) {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });
            
            const currentIcon = table.getElementsByTagName('th')[columnIndex].querySelector('.sort-icon');
            currentIcon.className = `fas fa-sort-${isAscending ? 'up' : 'down'} sort-icon`;
        }

        function getCellValue(row, columnIndex) {
            const cell = row.getElementsByTagName('td')[columnIndex];
            let value = cell.textContent.trim();
            
            // Remove special characters for sorting
            value = value.replace(/[@$,%]/g, '');
            
            // Return as number if possible
            return isNaN(value) ? value : parseFloat(value);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#influencerTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Real-time calculation of derived metrics
        function updateCalculatedMetrics() {
            try {
                const avgReelsView = parseFloat(document.getElementById('avgReelsView').value) || 0;
                const sponsoredReelsView = parseFloat(document.getElementById('sponsoredReelsView').value) || 0;
                const campaignReach = parseFloat(document.getElementById('campaignReach').value) || 0;
                const actualCost = parseFloat(document.getElementById('actualCost').value) || 0;
                const linkClicks = parseFloat(document.getElementById('linkClicks').value) || 0;
                const campaignER = parseFloat(document.getElementById('campaignEngagementRate').value) || 0;
                
                // Calculate derived metrics
                const performanceRatio = avgReelsView > 0 ? (sponsoredReelsView / avgReelsView).toFixed(2) : '-';
                const costPerReach = campaignReach > 0 ? (actualCost / campaignReach).toFixed(4) : '-';
                const costPerClick = linkClicks > 0 ? (actualCost / linkClicks).toFixed(2) : '-';
                
                // Calculate predicted ROI using ML-guided formula
                const followers = parseFloat(document.getElementById('followers').value) || 0;
                const qualityAudience = parseFloat(document.getElementById('qualityAudience').value) || 0;
                const turkey = parseFloat(document.getElementById('turkey').value) || 0;
                const score = parseFloat(document.getElementById('score').value) || 0;
                const commentRate = parseFloat(document.getElementById('commentRate').value) || 0;
                
                let predictedRoi = '-';
                if (campaignER > 0 && actualCost > 0) {
                    // ML-guided ROI calculation
                    const engagementScore = campaignER * 0.19;
                    const reachScore = sponsoredReelsView / 1000000 * 0.171;
                    const audienceSizeScore = followers / 1000000 * 0.157;
                    const qualityScore = qualityAudience / 100000 * 0.12;
                    const marketScore = turkey / 100 * 0.10;
                    const influenceScore = score / 100 * 0.08;
                    const commentEngagement = commentRate * 0.06;
                    const costEfficiency = 100000 / Math.max(actualCost, 1) * 0.05;
                    
                    const mlRoi = (engagementScore + reachScore + audienceSizeScore + qualityScore + 
                                  marketScore + influenceScore + commentEngagement + costEfficiency) * 1000;
                    predictedRoi = Math.round(mlRoi);
                }
                
                // Update display
                document.getElementById('performanceRatio').textContent = performanceRatio;
                document.getElementById('costPerReach').textContent = costPerReach;
                document.getElementById('costPerClick').textContent = costPerClick;
                document.getElementById('predictedRoi').textContent = predictedRoi;
                
            } catch (error) {
                console.error('Error calculating metrics:', error);
            }
        }
        
        // Add event listeners for real-time calculation
        ['avgReelsView', 'sponsoredReelsView', 'campaignReach', 'actualCost', 'linkClicks', 
         'campaignEngagementRate', 'followers', 'qualityAudience', 'turkey', 'score', 'commentRate'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', updateCalculatedMetrics);
            }
        });

        // Handle campaign form submission
        document.getElementById('campaignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                const campaignData = {};
                
                for (let [key, value] of formData.entries()) {
                    campaignData[key] = value;
                }
                
                // Validate data
                if (!campaignData.account.startsWith('@')) {
                    campaignData.account = '@' + campaignData.account;
                }
                
                // Calculate advanced ROI using post-campaign metrics
                const avgReelsView = parseFloat(campaignData.avgReelsView) || 0;
                const sponsoredReelsView = parseFloat(campaignData.sponsoredReelsView) || 0;
                const campaignReach = parseFloat(campaignData.campaignReach) || 0;
                const actualCost = parseFloat(campaignData.actualCost) || 0;
                const campaignER = parseFloat(campaignData.campaignEngagementRate) || 0;
                
                // Advanced ROI calculation (matches backend logic)
                const performanceScore = avgReelsView > 0 ? sponsoredReelsView / avgReelsView : 1.0;
                const reachEfficiency = campaignReach > 0 ? 1 / Math.max(actualCost / campaignReach, 0.001) : 0;
                const engagementQuality = campaignER * 10;
                const audienceQuality = parseFloat(campaignData.qualityAudience) / 100000;
                const linkClicks = parseFloat(campaignData.linkClicks) || 0;
                const clickEfficiency = linkClicks > 0 ? 100 / Math.max(actualCost / linkClicks, 1) : 0;
                const marketFactor = parseFloat(campaignData.turkey) / 100;
                
                const advancedRoi = (
                    performanceScore * 0.25 +
                    reachEfficiency * 0.20 +
                    engagementQuality * 0.20 +
                    audienceQuality * 0.15 +
                    clickEfficiency * 0.10 +
                    marketFactor * 0.10
                ) * 1000;
                
                const roi = Math.round(advancedRoi);
                
                // Add to data array with enhanced post-campaign data
                influencerData.push({
                    account: campaignData.account,
                    roi: roi,
                    followers: parseInt(campaignData.followers),
                    engagement: campaignER,  // Use actual campaign engagement rate
                    postPrice: actualCost,   // Use actual cost instead of estimated
                    turkey: parseInt(campaignData.turkey),
                    qualityAudience: parseInt(campaignData.qualityAudience),
                    commentRate: parseFloat(campaignData.commentRate),
                    // New post-campaign metrics
                    avgReelsView: avgReelsView,
                    sponsoredReelsView: sponsoredReelsView,
                    campaignReach: campaignReach,
                    linkClicks: linkClicks,
                    performanceRatio: performanceScore.toFixed(2),
                    costPerReach: campaignReach > 0 ? (actualCost / campaignReach).toFixed(4) : 0,
                    costPerClick: linkClicks > 0 ? (actualCost / linkClicks).toFixed(2) : 0
                });
                
                // Re-sort by ROI
                influencerData.sort((a, b) => b.roi - a.roi);
                
                // Update displays
                updateDashboard();
                updateInfluencerTable();
                
                // Show success message
                document.getElementById('successAlert').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successAlert').style.display = 'none';
                }, 3000);
                
                // Reset form and calculated metrics
                this.reset();
                updateCalculatedMetrics();
                
                // Send data to backend to update CSV
                fetch('/api/add-campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(campaignData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        console.log('Campaign data saved successfully:', result);
                        // Reload data to reflect changes
                        loadInfluencerData();
                    } else {
                        throw new Error(result.error || 'Failed to save campaign data');
                    }
                })
                .catch(error => {
                    console.error('Error saving campaign data:', error);
                    document.getElementById('errorMessage').textContent = 'Failed to save data: ' + error.message;
                    document.getElementById('errorAlert').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('errorAlert').style.display = 'none';
                    }, 5000);
                });
                
                console.log('Campaign data to be saved:', campaignData);
                
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorAlert').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorAlert').style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>
